<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html"></link>
<script src="../js-cookie/src/js.cookie.js"></script>

<dom-module id="glg-current-user">
  <template>
    <iron-ajax
      id="xhr"
      handle-as="json"
      with-credentials="true"
      on-response="_handleUser"
      url="[[url]]"
      params="[[qs]]"
    >
    </iron-ajax>
    <iron-ajax auto
      id="gdsEcho"
      handle-as="json"
      with-credentials="true"
      on-response="_handleGDSUser"
      url="[[echoUrl]]"
    >
    </iron-ajax>
    <template is="dom-if" if="{{debug}}">
      <div>Hello <span>[[user.firstName]]</span>,</div>
      <div>Your username is <span>{{user.loginName}}</span></div>
      <div>Your person ID is <span>{{user.personId}}</span></div>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'glg-current-user',
    properties: {
      url: {
        type: String,
        value: 'https://epistream.glgresearch.com/epi/epiquery1/glglive/glgCurrentUser/getUserByLogin.mustache',
      },
      qs: {
        type: String,
        computed: '_buildQueryString(username)',
        value: ''
      },
      echoUrl: {
        type: String,
        value: 'https://ms-tools.glgresearch.com/echo/'
      },
      username: {
        type: String,
        value: function() {
          return this.username
        },
        observer: '_usernameChanged',
        notify: true,
        reflect: true
      },
      // Property to bind to get the current user
      user: {
        type: Object,
        notify: true
      },
      debug: {
        type: Boolean,
        notify: true,
        value: false
      }
    },
    _domainifyUsername: function(name) {
      if (name.toLowerCase().indexOf('glgroup') === -1) {
        return "glgroup\\" + name;
      } else {
        return name;
      }
    },
    _handleUser: function(evt) {
      this.user = evt.detail.response[0]
    },
    _handleGDSUser: function(res) {
      this.username = res.detail.response['x-identity']
    },
    _buildQueryString: function(name) {
      return {login : this._domainifyUsername(name)};
    },
    _usernameChanged: function(name) {
      return this.debounce('fetch', (function(_this) {
        return function() {
          return _this.$.xhr.generateRequest();
        };
      })(this), 200);
    },
    ready: function () {
      return this.debounce('fetch', (function(_this) {
        return function() {
          return _this.$.gdsEcho.generateRequest();
        };
      })(this), 200);
    }
  });
</script>
